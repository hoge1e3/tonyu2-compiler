var staKey;
var notDelete={};
var delsta;
var delArea=["北海道","孤立"];

for(var i=0;i<delArea.length;i++){
    deleteArea(delArea[i]);
}

initLineSegments();
initLineDists();

//print ( new Board().initSegments(Object.keys($stations).filter\(x){return !x.match(/point/);})+"" );

/*for(staKey of Object.keys($stations)){//key:駅名のみを配列型で取得
    if(isSimpleStation(staKey) && (!notDelete[staKey])) {
        delsta=staKey;
        reConnect(delsta);
        delete $stations[delsta];
        logDeleteStations(delsta);
    }
}*/

\isSimpleStation(staKey:String) {
    // 接続駅ではない途中駅か
    return $stations[staKey].lines.length==1 && $stations[staKey].nexts.length==2 && notConnectedToPoint(staKey);
}
\notConnectedToPoint(staName){
    var checksta = $stations[staName].nexts;
    for(var i=0;i<checksta.length;i++){
        if(checksta[i].indexOf("point")>-1){
            return false;
        }
    }
    return true;
}

\logDeleteStations(logDelete){
    textName = "deleteStations.txt";
    f=file(textName);//freelog.txt
    f.appendText(logDelete+"\n");
}


\reConnect(staName){
    var next_0 = $stations[staName].nexts[0];
    var next_0_len = $stations[next_0].nexts.length;
    notDelete[next_0]=true;
    var next_1 = $stations[staName].nexts[1];
    var next_1_len = $stations[next_1].nexts.length;
    notDelete[next_1]=true;
    
    for(var i=0;i<next_0_len;i++){
        if($stations[next_0].nexts[i]==staName){
            $stations[next_0].nexts[i]=next_1;
        }
    }
    for(var i=0;i<next_1_len;i++){
        if($stations[next_1].nexts[i]==staName){
            $stations[next_1].nexts[i]=next_0;
        }
    }
}
\initLineSegments() {
    $lineSegments={};
    for(let staKey of Object.keys($stations)){
        if (!isSimpleStation(staKey)) continue;
        let st=$stations[staKey];
        for (let nxName of st.nexts) {
            if (!isSimpleStation(nxName)) continue;
            let els=$stations[nxName].lineSegment;
            if (els) {
                let mys=st.lineSegment;
                if (mys && els!==mys) {
                    //Merge
                    for (let e of els) {
                        $stations[e].lineSegment=mys;
                        mys.push(e);
                    }
                } else {
                    st.lineSegment=els;
                    els.push(staKey);
                }
            }
        }        
        if (!st.lineSegment) {
            $lineSegments[staKey]=st.lineSegment=[staKey];
        }
    }
    for (let k of Object.keys($lineSegments)) {
        if ($lineSegments[k].length==1) {
            delete $stations[k].lineSegment;
            delete $lineSegments[k];
        }
    }
    for(let sg,stas in $lineSegments){
        for (let sta of stas) {
            $stations[sta].lineSegment=sg;
        }
    }
    //print($lineSegments);
    /*for (let k, sta in $stations) {
        print(k, sta.lineSegment);
    }*/
}
\initLineDists() {
    let lineDists={};// {[String]: {[String]:Number}}
    \add(a,b,d) {
        if (a>b) return add(b,a,d);
        lineDists[a]=lineDists[a]||{};
        let la=lineDists[a];
        if (!la[b] || d<la[b]) {
            la[b]=d;
            //print(a,b,d);
            return true;
        }
        return false;
    }
    \getAll(a:String) {// res: {[String]:Number}
        let res=Object.assign({},lineDists[a]||{});
        for (let b, dists in lineDists) {
            if (dists[a]) res[b]=dists[a];
        }
        return res;
    }
    for(let staKey,st in $stations){
        if (st.lines.length<2) continue;
        for (let a of st.lines) {
            for (let b of st.lines) {
                if (a===b) continue;
                add(a,b,1);
            }
        }
    }
    let step=1;
    let next;
    do {
        next=false;
        print("Detect Line Dists");
        for (let lineKeyA, la in $lines) {
            let distsAB=getAll(lineKeyA);
            //print(lineKeyA, distsAB);
            for (let lineKeyB, distAB in distsAB) {
                let distsBC=getAll(lineKeyB);
                for (let lineKeyC, distBC in distsBC) {
                    if (lineKeyC===lineKeyA) continue;
                    let distAC=distAB+distBC;
                    if (add(lineKeyA,lineKeyC, distAC)) next=true;
                }
            }
        }
    } while(next);
    $lineDists=lineDists;
    let undefs={};
    for (let a,_ of $lines) {
        for (let b,_ of $lines) {
            if (a>=b) continue;
            if (!$lineDists[a] || !$lineDists[a][b]) {
                print("Dist Undef", a, b);
                undefs[a]=1;
                undefs[b]=1;
            }
        }
    }
    for (let k,_ in undefs) {
        print(k,$lineDists[k],getAll(k));
    }
    //print(lineDists);
    return lineDists;
}

\deleteArea(areas){//このままだと接続駅も消えるので、１駅でも消す地方に紛れ込んでたらアウト(門司とか)
    let delLine=$areas[areas].lines;
    for(var i=0;i<delLine.length;i++){
        for(staKey of Object.keys($stations)){//key:駅名のみを配列型で取得
            if($stations[staKey].lines.indexOf(delLine[i])>-1){
                delsta=staKey;
                delete $stations[delsta];
                logDeleteStations(delsta);
            }
        }
    }
    for (let line of delLine) {
        delete $lines[line];
    }
}